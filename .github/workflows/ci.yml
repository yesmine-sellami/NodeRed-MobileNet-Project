name: CI/CD - NodeRed + AI Model

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test_and_deploy:
    name: Test + Deploy locally
    runs-on: self-hosted   # le pipeline tourne sur ton PC ou Raspberry

    steps:
      # 1ï¸âƒ£ RÃ©cupÃ©rer le code du dÃ©pÃ´t
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurer Node.js pour les tests dâ€™irrigation
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Node.js dependencies
        run: |
          npm install jest --save-dev

      - name: Run Node.js irrigation tests
        run: |
          npx jest tests/testIrrigation.test.js --verbose

      # 3ï¸âƒ£ Configurer Python pour les tests IA
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install Python dependencies
        run: |
          pip install tensorflow opencv-python numpy unittest-xml-reporting

      - name: Run AI model tests
        run: |
          python -m unittest discover -s tests -p "testscript.py" -v

      # 4ï¸âƒ£ Ã‰tape de dÃ©ploiement (si tout est OK)
      - name: Deploy application locally
        if: success()    # âœ… uniquement si les tests rÃ©ussissent
        run: |
          echo "âœ… Tous les tests sont passÃ©s, dÃ©ploiement local en cours..."

          # (Optionnel) redÃ©marrer Node-RED si installÃ© localement
          echo "ğŸ”„ RedÃ©marrage de Node-RED..."
          pkill -f "node-red" || true
          nohup node-red > node_red.log 2>&1 &

          # ğŸš€ Lancer le script principal IA
          echo "ğŸ§  Lancement du script dâ€™analyse IA..."
          python scripts/scriptai.py > ai_output.log 2>&1 &

          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s."
